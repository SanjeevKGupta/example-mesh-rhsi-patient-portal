#
# Makefile : payment-processor
#

# Check all necessary environment variables
-include ../../env.var.app.cmd.mk
-include ../../env.var.app.image.mk

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

export K_ARCH=${ARCH}
export K_DOCKER_IMAGE=${DOCKER_IMAGE}
export K_SERVICE_VERSION=${SERVICE_VERSION}

all: build push apply_kube

# Build the image 
build:
	@echo ""
	@echo "\033[1;30mBuilding image ${DOCKER_IMAGE}_$(ARCH):${SERVICE_VERSION} \033[0m"
	@docker build --platform linux/${ARCH} -t ${DOCKER_IMAGE}_$(ARCH):${SERVICE_VERSION} -f ./Dockerfile.${ARCH} .

# Push the docker container to the authenticatd CR
push:
	@echo ""
	@echo "\033[1;30mLogin into container registry ${CR_HOST} \033[0m"
	@echo "${CR_APP_API_KEY_RW_PUSH}" | docker login ${CR_HOST} -u ${CR_HOST_USERNAME} --password-stdin

	@echo ""
	@echo "\033[1;30mPushing image $(DOCKER_IMAGE)_$(ARCH):$(SERVICE_VERSION) \033[0m"
	@docker push $(DOCKER_IMAGE)_$(ARCH):$(SERVICE_VERSION)

-include ../../env.var.app.kube.mk
test_kube_envsubst:
	envsubst < ./kube/deploy-payment-processor.yaml.tmpl

check_var_namespace:
	$(call cmd_var_check,NAMESPACE,as make <target> NAMESPACE=<namespace>)
	@echo ""
	@echo "\033[1;30mCheching namespace ${NAMESPACE} \033[0m"
	@echo "NAMESPACE: ${NAMESPACE}"

# Build the docker container
create_namespace: check_var_namespace
	$(shell kubectl create namespace ${NAMESPACE} > /dev/null 2>&1)

create_image_pull_secret: create_namespace
	@echo ""
	@echo "\033[1;30mDeleting existing image pull secret ${K_MM_IMAGE_PULL_SECRET_PP_BACK} \033[0m"
	$(kubectl delete secret ${K_MM_IMAGE_PULL_SECRET_PP_BACK} -n ${NAMESPACE} > /dev/null 2>&1)

	@echo ""
	@echo "\033[1;30mCreating new image pull secret ${K_MM_IMAGE_PULL_SECRET_PP_BACK} \033[0m"
	$(shell kubectl create secret docker-registry ${K_MM_IMAGE_PULL_SECRET_PP_BACK} -n ${NAMESPACE} --docker-server=${CR_HOST} --docker-username=${CR_HOST_USERNAME} --docker-password=${CR_APP_API_KEY_RO_PULL} --docker-email="" > /dev/null 2>&1)

apply_kube: create_image_pull_secret
	@echo ""
	@echo "\033[1;30mDeleting existing deployment ${K_MM_NAME_PP_BACK} \033[0m"
	$(shell kubectl delete deploy ${K_MM_NAME_PP_BACK} -n ${NAMESPACE} > /dev/null 2>&1)

	@echo ""
	@echo "\033[1;30mCreating new deployment in namespace ${NAMESPACE} \033[0m"
	envsubst < ./kube/deploy-payment-processor.yaml.tmpl > ./kube/deploy-payment-processor.yaml | kubectl apply -n ${NAMESPACE} -f ./kube/deploy-payment-processor.yaml

# This imports the variables from hzn.json
.hzn.json.tmp.mk: hzn/hzn.json
	@ hzn util configconv -f $< > $@
